name: Release Glab3.0

on:
  workflow_dispatch:

jobs:
  build:
    name: Release Glab3.0 Firmware
    runs-on: ubuntu-latest

    steps:
    # ä¸‹è½½æºç 
    - name: â¬ Get nRF52-Keyboard source
      uses: actions/checkout@v2
      with:
        submodules: recursive
    # ä¸‹è½½å®‰è£…ç›¸å…³å·¥å…·
    - name: âš™ï¸ Install Tools
      run: |
        sudo apt-get update
        sudo apt-get -y install python3-pip python3-setuptools
        sudo pip3 install --upgrade pip
        sudo pip3 install nrfutil
        wget https://sourceforge.net/projects/sdcc/files/sdcc-linux-amd64/4.0.0/sdcc-4.0.0-amd64-unknown-linux2.5.tar.bz2 -O /tmp/sdcc-4.0.0-amd64-unknown-linux2.5.tar.bz2
        tar xf /tmp/sdcc-4.0.0-amd64-unknown-linux2.5.tar.bz2 -C /tmp
        sudo cp -r /tmp/sdcc-4.0.0/* /usr/local
        wget https://developer.arm.com/-/media/Files/downloads/gnu-rm/9-2019q4/gcc-arm-none-eabi-9-2019-q4-major-x86_64-linux.tar.bz2 -O /tmp/gcc-arm-none-eabi-9-2019-q4-major-x86_64-linux.tar.bz2
        tar xf /tmp/gcc-arm-none-eabi-9-2019-q4-major-x86_64-linux.tar.bz2 -C /tmp
        wget https://github.com/genokolar/nrf52_tools/raw/main/mergehex -O /tmp/mergehex
        sudo cp -r /tmp/mergehex /usr/local/bin/mergehex
        sudo chmod 0755 /usr/local/bin/mergehex
        echo GNU_INSTALL_ROOT := /tmp/gcc-arm-none-eabi-9-2019-q4-major/bin/>template/Makefile.posix
        echo GNU_VERSION := 9.2.1>>template/Makefile.posix
        echo GNU_PREFIX := arm-none-eabi>>template/Makefile.posix
    # ç¼–è¯‘å›ºä»¶
    - name: âš’ï¸ Make Firmware
      run: |
        cd keyboard
        make -j4
        cd ../
    # ç”Ÿæˆå‘å¸ƒtag
    - name: ğŸ‰ Generate release tag
      run: |
        echo "VERSION=11`git log --abbrev-commit --pretty=oneline -1 | cut -c 1-6 || echo 'unknown'`" >> $GITHUB_ENV
        echo "BUILDTIME=`date '+%Y%m%d'`" >> $GITHUB_ENV
    # ä¸Šä¼ ç¼–è¯‘ç”Ÿæˆçš„å›ºä»¶
    - name: ğŸ“¤ Upload Artifact Files
      uses: actions/upload-artifact@v2
      with:
        name: LotKB_Keyboard_Firmware_${{ env.BUILDTIME }}_${{ env.VERSION }}
        path: |
          ${{ github.workspace }}/keyboard/_build/*.zip
          ${{ github.workspace }}/keyboard/_build/*.hex
          ${{ github.workspace }}/keyboard/_build/*.bin
    # ä¸‹è½½ç¼–è¯‘ç”Ÿæˆçš„å›ºä»¶      
    - name: ğŸ“¥ Download Artifact Files
      uses: actions/download-artifact@v2
      with:
        name: LotKB_Keyboard_Firmware_${{ env.BUILDTIME }}_${{ env.VERSION }}
        path: ${{ github.workspace }}/keyboard/_build/Artifact
    # æ‰“åŒ…ç¼–è¯‘ç”Ÿæˆçš„å›ºä»¶
    - name: ğŸ“¦ï¸ ZIP Artifact Files
      run:  |
        cd ${{ github.workspace }}/keyboard/_build/Artifact
        zip -r ../LotKB_Keyboard_Firmware_${{ env.BUILDTIME }}_${{ env.VERSION }}.zip *
    # å‘å¸ƒå›ºä»¶åˆ°genokolar/nrf52-keyboardåº“
    - name: ğŸ Release Firmware
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.BUILDTIME }}-${{ env.VERSION }}
        name: SDK17.1 ${{ env.BUILDTIME }}-${{ env.VERSION }}
        repository: genokolar/nrf52-keyboard
        generate_release_notes: true
        files: |
          ${{ github.workspace }}/keyboard/_build/*.zip
          ${{ github.workspace }}/keyboard/_build/*.hex
      env:
          GITHUB_TOKEN: ${{ secrets.KEYBOARD }}
    # é€šè¿‡FTPä¸Šä¼ åˆ°ä¸ªäººHOST
    - name: ğŸ“‚ FTP upload firmware
      uses: SamKirkland/FTP-Deploy-Action@4.1.0
      with:
        server: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        local-dir: ${{ github.workspace }}/keyboard/_build/
        server-dir: /htdocs/down/Glab3.0/
        state-name: ../.sdk17-glab3.0-firmware-sync-state.json
        exclude: "[*/**, *-nrf52*_dfu-*.zip, *-nrf52*_kbd*.hex, *-ch554-*.bin]"
    # ä¸‹è½½CMSIS-DAP Flasheræºç 
    - name: â¬ Get CMSIS-DAP Flasher source
      uses: actions/checkout@v2
      with:
        repository: genokolar/cmsis-dap-flasher
        path: cmsis-dap-flasher
    # ä¸ºCMSIS-DAP Flasherç”Ÿæˆhexç›®å½•å­˜æ”¾å›ºä»¶
    - name: ğŸ—ƒ Generate Folder
      run: |
        cd ${{ github.workspace }}/cmsis-dap-flasher
        mkdir hex
        cd ${{ github.workspace }}
    # ä¸‹è½½ç¼–è¯‘ç”Ÿæˆçš„å›ºä»¶      
    - name: ğŸ“¥ Download Artifact Files
      uses: actions/download-artifact@v2
      with:
        name: LotKB_Keyboard_Firmware_${{ env.BUILDTIME }}_${{ env.VERSION }}
        path: ${{ github.workspace }}/cmsis-dap-flasher/hex/
    # æ›´æ–°CMSIS-DAP Flasher
    - name: ğŸ“ Update CMSIS-DAP Flasher Files
      run: |
        cd ${{ github.workspace }}/cmsis-dap-flasher
        # æ›¿æ¢å›ºä»¶ç‰ˆæœ¬ä¿¡æ¯
        sed -i 's/20220116-11dd5b41/${{ env.BUILDTIME }}-${{ env.VERSION }}/g' å¼€å§‹çƒ§å½•.bat
        # è½¬æ¢æˆWindowsæ¢è¡Œç¬¦
        sed -i ':label;N;s/\n/*#/;b label' å¼€å§‹çƒ§å½•.bat
        sed -i 's/*#/\r\n/g' å¼€å§‹çƒ§å½•.bat
        # åˆ é™¤HEXä¸‹å¤šä½™æ–‡ä»¶
        rm -rf ./hex/*.bin
        rm -rf ./hex/*-nrf52*_dfu-*.zip
        rm -rf ./hex/*-nrf52*_kbd*.hex
        cd ${{ github.workspace }}
    # æ‰“åŒ…CMSIS-DAP Flasher
    - name: ğŸ“¦ï¸ ZIP Artifact Files
      run:  |
        cd ${{ github.workspace }}/cmsis-dap-flasher
        zip -r CMSIS-DAPçº¿åˆ·åŒ…${{ env.BUILDTIME }}-${{ env.VERSION }}-SDK17.1.zip *
    # é€šè¿‡FTPä¸Šä¼ åˆ°ä¸ªäººHOST
    - name: ğŸ“‚ FTP upload CMSIS-DAP
      uses: SamKirkland/FTP-Deploy-Action@4.1.0
      with:
        server: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        local-dir: ${{ github.workspace }}/cmsis-dap-flasher/
        server-dir: /htdocs/down/Glab3.0/
        state-name: ../.cmsis-dap-flasher-glab3.0-sync-state.json
        exclude: "[*/**, *.bat, .gitignore]"
